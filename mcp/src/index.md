# Twilog MCPサーバー

## なぜこの実装が存在するか

### SQLiteベース実装の削除とラッパー化
**Problem**: 従来のMCPサーバーではSQLiteベースの独自実装（database.ts、filters.ts）が存在し、SearchEngineと同様のフィルタリング機能が重複実装されていた。この二重実装により、機能追加時の修正箇所が分散し、保守性が大幅に低下していた。また、SQLiteとCSVの二重データアクセス層により、アーキテクチャの一貫性が損なわれていた。

**Solution**: SQLiteベースの実装を完全削除し、twilog_server.pyへの単純なWebSocketラッパーとして再設計。database.tsとfilters.tsを削除し、全ての処理ロジックをtwilog_server.pyに一元化。MCPサーバーはJSON-RPC 2.0リクエストの転送と結果のフォーマット変換のみを担当し、検索・フィルタリング・統計処理は全てサーバー側で実行する分離アーキテクチャを採用した。

### 統一APIによる一貫性確保
**Problem**: MCPサーバー独自のメソッド名や処理方式により、CLI（search.py）とMCPで異なるAPIが提供され、開発者の学習コストが増加していた。また、機能の追加・変更時に複数箇所でのAPI修正が必要になり、一貫性の維持が困難だった。

**Solution**: twilog_server.pyで提供されるメソッド名（search_similar、get_user_stats、get_database_stats、search_posts_by_text、embed_text）と完全に一致するAPIを実装。MCPとCLIで同じメソッド名、同じパラメータ、同じ結果形式を提供することで、統一されたAPI体験を実現。開発者は単一のAPI仕様を学習するだけで、両方のインターフェースを活用可能になった。

### WebSocket通信の標準化
**Problem**: 独自のWebSocket通信実装により、JSON-RPC 2.0プロトコルとの互換性が不十分で、標準的なRPCライブラリとの連携が困難だった。また、エラーハンドリングやタイムアウト処理が分散し、通信の信頼性に課題があった。

**Solution**: 完全なJSON-RPC 2.0準拠の通信実装を採用。リクエスト形式`{"jsonrpc": "2.0", "method": "search_similar", "params": {...}, "id": 1}`、レスポンス形式`{"jsonrpc": "2.0", "result": {...}, "id": 1}`による標準プロトコル対応。Streaming Extensions形式の分割送信にも対応し、大容量結果の効率的な転送を実現。接続タイムアウト（5秒）、適切なエラーメッセージ、WebSocket接続の自動復旧機能により、堅牢な通信層を構築した。

### MCPプロトコル最適化
**Problem**: MCPツールの結果表示において、検索結果や統計情報を人間が読みやすい形式で提供する必要があったが、生のJSON形式では可読性が低く、MCPクライアントでの利用体験が劣化していた。

**Solution**: 各ツールの結果をMCPのcontentフォーマット（type: 'text'）に最適化して返却。検索結果は「順位: 類似度 - @ユーザー名」形式での整理、統計情報は表形式での見やすい表示、エラーメッセージの日本語対応により、MCPクライアントでの実用性を向上。結果の構造化により、Claude等のAIアシスタントが内容を理解しやすい形式を提供した。

### コマンドライン引数の簡素化
**Problem**: 従来の実装では`--db`引数によるSQLiteファイル指定が必要だったが、CSVベース統一により、データベースファイルが不要になった。しかし、WebSocketサーバーのURL指定は必要で、引数体系の見直しが必要だった。

**Solution**: `--db`引数を削除し、`--websocket`引数のみに簡素化。デフォルトURL（ws://localhost:8765）により引数省略を可能にし、基本的な利用では引数指定不要の簡単起動を実現。ヘルプ機能（`--help`、`-h`）により、利用方法の確認を容易にした。

### フィルタリング機能の委譲と個別パラメータ対応
**Problem**: MCPサーバー独自のフィルタリング実装（UserFilter、DateFilter、重複除去等）により、SearchEngineと同様の複雑なロジックが重複し、機能の同期が困難だった。また、フィルタリングパラメータの形式がSearchEngineと異なり、一貫性が欠如していた。さらに、CLIクライアントで利用可能な詳細なフィルタリング設定（SearchSettings）がMCPサーバーから利用できず、機能の不整合が発生していた。MCPクライアントからの利用を考慮すると、ネストした設定オブジェクトよりも個別パラメータの方が使いやすいという課題もあった。

**Solution**: 全てのフィルタリング機能をtwilog_server.pyのSearchEngineに委譲し、MCPサーバーではパラメータの転送のみを実行。MCPクライアントからは`user_filter`、`date_filter`、`top_k`、`remove_duplicates`を個別のオプショナルパラメータとして受け付け、サーバー送信時にSearchSettings形式に変換する方式を採用。これにより、MCPクライアントでの使いやすさを保ちながら、サーバー側の統一されたSearchSettings形式との互換性を確保した。integer型の適切な使用により、整数パラメータの型安全性も確保した。

### エラーハンドリングの統一
**Problem**: WebSocket通信、JSON解析、MCPレスポンス生成の各段階で個別のエラーハンドリングが必要だったが、従来の実装では不整合があり、デバッグが困難だった。

**Solution**: 階層的なエラーハンドリングシステムを実装。WebSocket接続エラー（ECONNREFUSED、ETIMEDOUT）の適切な分類、JSON-RPC 2.0エラーの標準的な処理、MCPレスポンスでのエラー情報の統一フォーマット化により、問題の特定と解決を効率化。全てのエラーメッセージを日本語化し、ユーザーフレンドリーな体験を提供した。