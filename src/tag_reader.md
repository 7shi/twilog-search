# TagReader

## なぜこの実装が存在するか

### 分散データファイルの統合読み込み必要性
**Problem**: タグ関連データが3つの異なるファイル形式（TSV、TXT、safetensors）に分散しており、個別に読み込むと処理が複雑になり、データの整合性確保が困難になる。

**Solution**: 単一のTagReaderクラスで3つのファイルを統合的に読み込み、データ間の関連性を自動的に構築する設計を採用。

### 遅延importによる軽量化
**Problem**: タグ分析のみが必要な場合でも、torch/safetensorsという重いライブラリが常に読み込まれ、起動時間とメモリ使用量が増大する。

**Solution**: ベクトル機能が不要な場合は重いライブラリを読み込まない選択制と、実際に使用するタイミングでのみimportする遅延import方式を採用。

### インデックスマッピングによる高速アクセス
**Problem**: tags.txtの順序でsafetensorsのベクトルが格納されているため、タグ名からベクトルを取得する際に毎回線形検索が必要になり、処理速度が低下する。

**Solution**: タグ名をキーとするインデックス辞書を事前構築し、O(1)でのベクトルアクセスを実現。

### 単純なTSV解析の採用
**Problem**: csvライブラリを使用すると、Noneフィールドの扱いやエラーハンドリングが複雑になり、シンプルなTSV構造に対して過剰な機能となる。

**Solution**: 単純な文字列分割による解析を採用し、エラー処理を簡素化しつつ、必要な機能のみを実装。