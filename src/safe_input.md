# safe_input

## なぜこの実装が存在するか

### 入力システムの分離
**Problem**: search.pyの入力処理機能が検索機能と密結合しており、他のモジュールから再利用できない状態だった。

**Solution**: readline履歴管理と入力検証機能を独立したモジュールとして分離し、コードの再利用性を高めた。

### 入力履歴の混在解決
**Problem**: 検索入力と設定入力が同じreadline履歴に混在し、ユーザーの意図しない履歴候補が表示される問題があった。

**Solution**: コンテキスト別の履歴管理システムを実装し、検索履歴と設定履歴を分離してユーザビリティを向上させた。

### 入力検証の統一化
**Problem**: 各種入力処理で個別に検証ロジックが実装されていたため、バリデーション処理が散在していた。

**Solution**: 統一的な入力検証機能を持つ関数群を提供し、一貫性のある入力処理を実現した。

### 履歴コンテキストの必須化
**Problem**: 履歴管理が任意だった場合、開発者が履歴コンテキストを指定し忘れ、意図しない履歴の混在が発生する可能性があった。

**Solution**: 全ての入力関数でhistory引数を必須とし、明示的な履歴コンテキスト指定を強制することで、履歴の適切な分離を保証した。

### readline競合問題の根本解決
**Problem**: rich.promptライブラリとreadlineライブラリの競合により、バックスペースキーで全文字が削除される致命的な問題と、カーソルキー移動が無効化される問題が発生していた。

**Solution**: rich.promptを排除し、readline + 標準input()の組み合わせに変更した。これにより、日本語入力、カーソルキー移動、バックスペース削除が全て正常動作し、環境依存問題も解決した。

### 安全な入力システムの構築
**Problem**: rich.promptの除去により、バリデーション機能や統一されたエラーハンドリングが失われ、入力処理の品質低下が懸念された。

**Solution**: `safe_text_input()`と`safe_number_input()`関数を実装し、バリデーション機能、デフォルト値表示、統一されたエラーハンドリング（Ctrl+C/Ctrl+D対応）を提供。rich.promptと同等の機能性を維持しながら、readline競合問題を完全に回避した。入力関数の仕様を統一し、保守性も向上させた。

### ハイブリッドUI構成の採用
**Problem**: 単一ライブラリでは全ての要件（Escキーキャンセル、日本語対応、美しい表示、安定したテキスト入力）を満たすことができなかった。

**Solution**: 最終的にハイブリッド構成を採用：
- **readline + 標準input()**: テキスト入力（日本語・カーソルキー・バックスペース完全対応）
- **simple_term_menu**: メニュー選択（Escキーキャンセル対応）
- **rich表示**: 検索結果の美しい表示（パネル・色付け・ルール）
この組み合わせにより、各ライブラリの強みを活かしつつ弱点を回避し、全ての要件を満たす安定したシステムを実現した。

### 履歴コンテキストの項目別分離
**Problem**: 全ての設定入力で同一の履歴コンテキストを使用していたため、異なる種類の入力値が混在し、履歴機能の有用性が低下していた。

**Solution**: 入力項目ごとに個別の履歴コンテキストを割り当てる方式を採用。「user」（ユーザー名関連）、「threshold」（投稿数閾値）、「top_k」（表示件数）、「date_input」（日付入力）に分離し、同種の設定では履歴を共有する設計とした。これにより、過去の入力履歴がより適切に再利用され、設定効率が向上した。

### Linux環境での日本語入力最適化
**Problem**: Linux環境の標準readlineで日本語入力時に問題が発生し、文字入力の品質が低下していた。

**Solution**: `gnureadline`を優先的に使用することでLinux環境での日本語入力を改善。Windows環境では`gnureadline`が対応していないため、標準`readline`にフォールバックする選択的実装を採用し、環境依存問題を解決した。

### ユーザー名Tab補完機能の実装
**Problem**: ユーザー名入力時に正確な名前を覚えていない場合や、タイポが発生しやすい場合に、入力効率が低下している。

**Solution**: `safe_text_input_with_user_completion`関数を実装し、ユーザー名のTab補完機能を提供。readlineの`set_completer`と`_user_completer`関数を使用して前方一致によるユーザー名候補を表示し、コンマ区切りの複数入力にも対応。`parse_and_bind("tab: complete")`で補完機能を有効化し、入力完了後は`parse_and_bind("tab: self-insert")`で無効化することで、他の入力場面への影響を防止。補完設定の保存・復元により既存システムとの完全な統合を実現した。

### UserInfoクラス統合によるユーザー情報管理の改善
**Problem**: グローバル変数`_user_completion_list`と関数`_user_completer`を使用したユーザー名補完機能は、状態管理が分散しており、コードの再利用性と保守性が低下していた。また、ユーザー一覧の更新や補完機能の拡張が困難だった。

**Solution**: UserInfoクラスとの統合により、ユーザー情報管理を一元化。`safe_text_input_with_user_completion`関数はUserInfoインスタンスを受け取り、`user_info.user_completer`メソッドを`set_completer`に直接設定する設計に変更。グローバル変数を完全に削除し、ユーザー一覧の管理、補完機能、類似ユーザー提案機能を単一のクラスに集約。これにより、コードの理解性と保守性が向上し、ユーザー関連機能の拡張が容易になった。
